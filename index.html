<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Feora Finans</title>
<style>
body{margin:0;font-family:-apple-system;background:#0f172a;color:white}
header{padding:15px;text-align:center;background:#111827}
h2{margin:0}
.container{padding:15px}
.card{background:#1f2937;padding:15px;border-radius:10px;margin-bottom:15px}
button{padding:8px 12px;border:none;border-radius:6px;background:#dc2626;color:white;margin-top:5px}
input,select{padding:8px;border-radius:6px;border:none;margin:4px 0;width:100%}
table{width:100%;border-collapse:collapse;font-size:13px}
td,th{padding:6px;border-bottom:1px solid #333}
.login{display:flex;flex-direction:column;gap:10px;padding:40px}
</style>
</head>
<body>

<div id="loginScreen" class="login">
<h2>Giriş Yap</h2>
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Şifre">
<button onclick="login()">Giriş</button>
</div>

<div id="app" style="display:none">
<header><h2>Feora Ön Muhasebe</h2></header>

<div class="container">

<div class="card">
<h3>Kasa: <span id="kasa">0</span></h3>
<h3>Net Kar: <span id="kar">0</span></h3>
</div>

<div class="card">
<h3>Cari Seç</h3>
<select id="cariSelect"></select>
<button onclick="yeniCari()">Yeni Cari</button>
</div>

<div class="card">
<h3>İşlem Ekle</h3>
<select id="islemTip">
<option value="gelir">Gelir</option>
<option value="gider">Gider</option>
<option value="tahsilat">Tahsilat</option>
<option value="odeme">Ödeme</option>
</select>
<input id="tutar" type="number" placeholder="Tutar">
<button onclick="islemEkle()">Kaydet</button>
</div>

<div class="card">
<h3>Cari Bakiyeleri</h3>
<div id="cariBakiyeler"></div>
</div>

<div class="card">
<h3>Hareketler</h3>
<table>
<thead>
<tr><th>Tarih</th><th>Cari</th><th>Tip</th><th>Tutar</th><th></th></tr>
</thead>
<tbody id="liste"></tbody>
</table>
</div>

</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB67ll8JL4UQhv2z-nV-j8VNdOdWpXNdDY",
  authDomain: "feora-finans.firebaseapp.com",
  projectId: "feora-finans",
  storageBucket: "feora-finans.firebasestorage.app",
  messagingSenderId: "190320479090",
  appId: "1:190320479090:web:8cc249c9688db5b427ebeb"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let transactions=[];
let cariler=[];
let transRef;
let cariRef;

window.login = async ()=>{
const email=document.getElementById("email").value;
const pass=document.getElementById("password").value;
await signInWithEmailAndPassword(auth,email,pass)
.catch(()=>alert("Giriş Hatalı"));
};

onAuthStateChanged(auth,(user)=>{
if(user){
document.getElementById("loginScreen").style.display="none";
document.getElementById("app").style.display="block";

transRef=collection(db,"transactions");
cariRef=collection(db,"cariler");

onSnapshot(transRef,s=>{
transactions=s.docs.map(d=>({id:d.id,...d.data()}));
render();
});

onSnapshot(cariRef,s=>{
cariler=s.docs.map(d=>({id:d.id,...d.data()}));
renderCariler();
});
}
});

function tl(x){
return Number(x).toLocaleString("tr-TR",{style:"currency",currency:"TRY"});
}

function render(){
let kasa=0;
let gelir=0;
let gider=0;
let cariBakiye={};

transactions.forEach(t=>{
if(!cariBakiye[t.cariId]) cariBakiye[t.cariId]=0;

if(t.type==="gelir"){gelir+=t.amount;cariBakiye[t.cariId]+=t.amount;}
if(t.type==="gider"){gider+=t.amount;cariBakiye[t.cariId]-=t.amount;}
if(t.type==="tahsilat"){kasa+=t.amount;cariBakiye[t.cariId]-=t.amount;}
if(t.type==="odeme"){kasa-=t.amount;cariBakiye[t.cariId]+=t.amount;}
});

document.getElementById("kasa").innerText=tl(kasa);
document.getElementById("kar").innerText=tl(gelir-gider);

let liste=document.getElementById("liste");
liste.innerHTML="";
transactions.slice().reverse().forEach(t=>{
let cari=cariler.find(c=>c.id===t.cariId);
liste.innerHTML+=`
<tr>
<td>${new Date(t.date).toLocaleDateString()}</td>
<td>${cari?cari.name:"-"}</td>
<td>${t.type}</td>
<td>${tl(t.amount)}</td>
<td><button onclick="sil('${t.id}')">X</button></td>
</tr>`;
});

let bakiyeDiv=document.getElementById("cariBakiyeler");
bakiyeDiv.innerHTML="";
for(let id in cariBakiye){
let cari=cariler.find(c=>c.id===id);
bakiyeDiv.innerHTML+=`${cari?cari.name:"-"} : ${tl(cariBakiye[id])}<br>`;
}
}

function renderCariler(){
let select=document.getElementById("cariSelect");
select.innerHTML="";
cariler.forEach(c=>{
select.innerHTML+=`<option value="${c.id}">${c.name}</option>`;
});
}

window.yeniCari = async ()=>{
let name=prompt("Cari Adı");
if(!name) return;
await addDoc(cariRef,{name,createdAt:new Date()});
};

window.islemEkle = async ()=>{
let type=document.getElementById("islemTip").value;
let amount=Number(document.getElementById("tutar").value);
let cariId=document.getElementById("cariSelect").value;
if(!amount||!cariId) return;
await addDoc(transRef,{type,amount,cariId,date:new Date().toISOString()});
document.getElementById("tutar").value="";
};

window.sil = async (id)=>{
await deleteDoc(doc(db,"transactions",id));
};

</script>
</body>
</html>
